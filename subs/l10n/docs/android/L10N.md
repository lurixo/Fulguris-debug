# Android Localization Tools

## Overview

This document describes the translation process and tools for managing Android application localization.

**Note:** This is a generic reference for the strings.py, changelogs.py, and publish_google_play.py tools. For project-specific translation status and instructions, refer to your project's L10N.md file.

## Language Code Reference

**Resource Code** vs **Google Play Code:**
- **Resource Code**: Android resource directory format (e.g., `ar-rSA`, `zh-rCN`) used in `app/src/main/res/values-*/`
- **Google Play Code**: Language code used by Google Play Console for store listings (see [Google Play supported languages](https://support.google.com/googleplay/android-developer/table/4419860?hl=en))
- **Google Play uses mixed formats**:
  - Some use 2-letter ISO codes: `ar`, `hr`, `id`, `lt`, `ro`, `sr`, `th`, `uk`, `vi`
  - Most use full locale codes: `cs-CZ`, `da-DK`, `de-DE`, `el-GR`, `en-US`, `es-ES`, `fi-FI`, `fr-FR`, `hu-HU`, `it-IT`, `ja-JP`, `ko-KR`, `nl-NL`, `no-NO`, `pl-PL`, `pt-BR`, `pt-PT`, `ru-RU`, `sv-SE`, `tr-TR`, `zh-CN`, `zh-TW`

## Prerequisites

### UTF-8 Terminal Setup (Windows)

**CRITICAL:** Before using the L10N tool, you must ensure your terminal supports UTF-8 encoding. Without proper UTF-8 support, translations in non-Latin scripts (Arabic, Chinese, Japanese, Korean, Thai, etc.) will be corrupted.

#### PowerShell UTF-8 Setup

**Option 1: Set UTF-8 for Current Session (Quick)**
```powershell
# Run this at the start of each session
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$env:PYTHONIOENCODING = "utf-8"
```

**Option 2: Permanent UTF-8 Configuration (Recommended)**

1. **Enable UTF-8 system-wide** (Windows 10 1903+):
   - Open **Settings** ‚Üí **Time & Language** ‚Üí **Language**
   - Click **Administrative language settings**
   - Click **Change system locale...**
   - Check **"Beta: Use Unicode UTF-8 for worldwide language support"**
   - Restart your computer

2. **Configure PowerShell Profile** (run even if using system-wide setting):
   ```powershell
   # Edit your PowerShell profile
   notepad $PROFILE

   # Add these lines to the profile:
   [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
   $env:PYTHONIOENCODING = "utf-8"

   # Save and reload profile
   . $PROFILE
   ```

3. **Configure Windows Terminal** (if using Windows Terminal):
   - Open Settings (Ctrl+,)
   - Go to **Profiles** ‚Üí **Defaults**
   - Scroll to **Advanced** section
   - Set **"Text encoding"** to **"UTF-8"**

#### Verify UTF-8 Support

Test that your terminal can display Unicode characters:
```powershell
# Should display properly: Êó•Êú¨Ë™û ‰∏≠Êñá ÌïúÍµ≠Ïñ¥ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ‡πÑ‡∏ó‡∏¢ ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ ◊¢◊ë◊®◊ô◊™
python strings.py --get ja-rJP app_name
python strings.py --get zh-rCN app_name
python strings.py --get ar-rSA app_name
```

If you see garbled text or `?` characters, UTF-8 is not properly configured.

#### Troubleshooting

**Problem:** `UnicodeEncodeError` or garbled characters when running L10N commands

**Solution:**
1. Close all terminal windows
2. Apply UTF-8 configuration above
3. Open a fresh terminal
4. Run the verification test
5. If still broken, enable system-wide UTF-8 (requires restart)

**Problem:** L10N tool outputs blank/empty strings

**Solution:** The tool may be suppressing output due to encoding errors. Enable UTF-8 and restart terminal.

## Translation Tool: `strings.py`

The `strings.py` script is a comprehensive Python-based localization tool that manages all translation operations for the project.

**IMPORTANT:** Ensure UTF-8 terminal support is configured before using this tool (see Prerequisites above).

### Key Features

- **Batch Translation**: Update multiple strings at once
- **Strict Update Mode**: `--set` only updates existing strings to prevent accidental additions
- **English-Only Addition**: `--add` command adds new strings to English source file only
- **Source Editing**: Use `source` as language code to edit English source file directly
- **Windows Line Endings**: Detects and preserves CRLF (`\r\n`) line endings on Windows
- **Two Check Modes**: Incremental (day-to-day) and Full (quality audit) translation checking
- **Changed String Detection**: `--changed` command detects when source strings have been modified
- **Source Order Sorting**: `--sort` command reorders translation files to match source element order
- **Quality Checking**: Detect untranslated strings, near-match issues, and **CRITICAL placeholder mismatches** that cause app crashes
- **Plural Support**: Handle complex plural forms for different languages
- **XML Handling**: Support for complex XML with `<xliff:g>` tags
- **Near-Match Detection**: Find strings differing by 1-2 characters (punctuation, typos)
- **Automated Operations**: Add/remove strings across all language files
- **Unused String Detection**: Find strings defined but not used in code

### Translation Process

**Note:** All commands should be run in your existing terminal session on Windows using PowerShell. Do not spawn new terminal windows.

#### 1. Check Translation Status

The tool supports two check modes for different workflows:

**INCREMENTAL Mode (default)** - For day-to-day translation work:
- Only flags strings that are **missing** from the translated file
- Strings present in the translated file are assumed to be correct
- Use this mode when adding new translations incrementally

**FULL Mode (`--full`)** - For quality audits:
- Also flags strings that **match English exactly** even if in translated file
- Catches strings that were copied but not actually translated
- Use this mode when setting up a new language or doing quality audits

```bash
# INCREMENTAL: Check all languages (default, day-to-day work)
python strings.py --check

# INCREMENTAL: Check specific language
python strings.py --check ko-rKR

# FULL: Quality audit of all languages
python strings.py --check --full

# FULL: Quality audit of specific language
python strings.py --check th-rTH --full

# Either mode with near-match detection
python strings.py --check ko-rKR --near 1
python strings.py --check ko-rKR --full --near 1
```

**The check command automatically validates:**
- Untranslated strings (matching English exactly)
- Near-match strings (1-2 character differences, possibly punctuation errors)
- **[CRITICAL] Placeholder mismatches** - Missing or incorrect format placeholders like `%s`, `%1$s`, `%d` that **WILL cause app crashes**

**Example output for critical issues:**
```
fi-rFI (8 issues, 3 CRITICAL):
  [CRITICAL] Placeholder mismatch: dialog_title_incoming_url
    English: ['%1$s']
    Translation: []
    WARNING: This WILL cause app crashes!
```

Always fix CRITICAL placeholder issues immediately - these cause runtime crashes!

#### 1b. Detect Changed Source Strings

Use the `--changed` command to detect when source strings have been modified and need translation updates:

```bash
# Detect source strings that differ from en-rUS
python strings.py --changed
```

**How it works:**
- Compares English source (`values/strings.xml`) with `en-rUS` (`values-en-rUS/strings.xml`)
- If they differ, the source string has been modified
- All translations need to be reviewed and updated

**Output categories:**
- üîÑ **CHANGED** - Source differs from en-rUS ‚Üí All translations need updating
- üì• **NEW** - In source but not in en-rUS ‚Üí Need to add to en-rUS first
- üì§ **OBSOLETE** - In en-rUS but not in source ‚Üí May need removal

**Workflow for changed strings:**
```bash
# 1. Run --changed to find modified source strings
python strings.py --changed

# 2. Review each change and update en-rUS to match source
python strings.py --set string_id en-rUS 'Updated text'

# 3. Then update all other language translations
python strings.py --set string_id de-rDE 'Aktualisierter Text' fr-rFR 'Texte mis √† jour'
```

#### 1c. Sort Strings to Match Source Order

Use the `--sort` command to reorder strings in translation files to match the source file order:

```bash
# Reorder all translation files to match source order
python strings.py --sort

# Reorder a specific language
python strings.py --sort ko-rKR
```

**How it works:**
- Reads the order of elements from the English source file (`values/strings.xml`)
- Reorders all `<string>`, `<plurals>`, and `<string-array>` elements in translation files to match
- Maintains the interleaved order (strings and plurals mixed together as in source)
- Maintains proper XML indentation and line endings

**When to use:**
- After batch translations to align element order with source
- Before code review to make diffs easier to read
- To maintain consistency across language files
- After importing translations from external sources

#### 2. Translate Strings

**‚ö†Ô∏è IMPORTANT: Translation Workflow**

The `--set` command adds or updates translations in language files. A string must exist in the English source file (`values/strings.xml`) before it can be translated.

**Command Format:**
```bash
python strings.py --set <string_id> <lang1> <value1> [<lang2> <value2> ...]
```

**Translation Workflow:**
1. String must exist in English source file
2. Use `--set` to add the translation to one or more language files
3. Language files only contain translated strings (not copies of English)
4. This allows accurate tracking of translation progress

**Translate a Single Language:**
```bash
python strings.py --set settings_title ko-rKR 'ÏÑ§Ï†ï'
# Adds or updates the translation
# Will error if string doesn't exist in English
```

**Translate Multiple Languages at Once (for same string):**
```bash
python strings.py --set app_name de-rDE 'Fulguris' fr-rFR 'Fulguris' es-rES 'Fulguris'
# Updates the same string across multiple languages in one command
```

**Translate Multiple Strings in One Language (for bulk translation):**
```bash
python strings.py --set-batch de-rDE app_name 'Fulguris' settings 'Einstellungen' exit 'Beenden'
# Updates multiple different strings in a single language
# Efficient for translating 10-20 strings at a time
```

**Add New String to English (Developers Only):**
```bash
python strings.py --add settings_title 'Settings'
# Adds the string to English source file (values/strings.xml) ONLY
# Language files should only contain translated strings
```

**Complex XML Strings (with --raw flag):**
```bash
python strings.py --raw --set match_x_of_n ko-rKR '<xliff:g id="current_match">%1$d</xliff:g>Í∞ú Ï§ë'
```

**Edit English Source Strings (Developers Only):**

Use the special `source` language code to edit the English source file directly:
```bash
# Read a string from English source
python strings.py --get source settings

# Update an existing English source string
python strings.py --set settings source 'Settings'

# Update source and multiple languages at once
python strings.py --set app_name source 'Fulguris' en-rUS 'Fulguris' en-rGB 'Fulguris'

# NOTE: To ADD new strings to English, use --add instead:
python strings.py --add new_string 'New Value'
```

#### 3. Add or Remove Strings (Developers Only)

**‚ö†Ô∏è These commands are for developers managing string resources, NOT for translators.**

```bash
# Add a new string to English source file only
python strings.py --add new_feature_name 'New Feature'
# Translators then use --set to add translations to their language files

# Remove a string from all language files
python strings.py --remove obsolete_string_id
```

After adding a new string to English, translators use `--set` to add translations to each language file.

#### 4. Handle Plurals

```bash
# Get current plural values
python strings.py --get-plurals ko-rKR notification_incognito_running_title

# Set plural values
python strings.py --set-plurals ko-rKR pref_summary_cookies \
  zero 'ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê Ïø†ÌÇ§Í∞Ä ÏóÜÏäµÎãàÎã§' \
  one 'ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê Ïø†ÌÇ§Í∞Ä 1Í∞ú ÏûàÏäµÎãàÎã§' \
  other 'ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê Ïø†ÌÇ§Í∞Ä %dÍ∞ú ÏûàÏäµÎãàÎã§'
```

#### 5. Get String Values

Get a single language:
```bash
python strings.py --get ko-rKR settings_title
```

Get from English source:
```bash
python strings.py --get source settings_title
```

Get from ALL languages (shows all translations):
```bash
python strings.py --get all settings_title
# or
python strings.py --get-all settings_title
```

Output format shows language name, code, and translation:
```
String ID: settings_title
================================================================================
English (Source) - source: "Settings"
Afrikaans - af-rZA: "Instellings"
Arabic - ar-rSA: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™"
...
```

### Exclusion Rules

The check tool automatically excludes certain strings from being flagged as untranslated:

**International Terms** (no translation needed):
- `WebView`, `Android`, `iOS`, `Linux`, `macOS`, `Windows`, `Desktop`, `Mobile`
- `JavaScript`, `Cookies`, `Port:`, `LeakCanary`

**String Prefixes** (technical identifiers):
- `agent_*` - User agent strings (e.g., `agent_android_mobile`)
- `log_level_*` - Log level names (e.g., `log_level_warn`)

**Special Strings**:
- `@string/...` - String references
- `android_open_source_project`, `jsoup`, `infinity`, `search_action` - Proper nouns

**Short Strings**:
- Strings with ‚â§3 characters are excluded from checks

### PowerShell Quoting Tips

When using PowerShell, use single quotes for outer container:

```powershell
# Simple strings - use single quotes
python strings.py --set dialog_title ko-rKR 'ÏÑ§Ï†ï'

# Multiple languages at once (RECOMMENDED)
python strings.py --set app_name de-rDE 'Fulguris' fr-rFR 'Fulguris' es-rES 'Fulguris'

# Strings with placeholders - single quotes work perfectly, $ is literal
python strings.py --set dialog_title ko-rKR '%1$s Ïó¥Í∏∞'

# Strings with double quotes - no escaping needed with single quotes!
python strings.py --set session_switched ko-rKR 'Ï†ÑÌôòÎê® "%s"'

# Strings with apostrophes (single quotes) - double them up
python strings.py --set action_dont_allow th-rTH 'Don''t allow'
python strings.py --set save_data th-rTH 'Request ''Save-Data'''

# Complex XML strings - single quotes, no escaping needed!
python strings.py --raw --set message_ssl_error sv-rSE 'Text:\n<xliff:g id="name" example="value">%1$s</xliff:g>'
```

**PowerShell quoting rules:**
- **Single quotes**: ALWAYS use these. Everything is literal, no variable expansion. Dollar signs `$` work perfectly. Only apostrophes need doubling `''`.
- **Double quotes**: AVOID - risk of variable interpolation and require backtick escaping
- **DO NOT use here-strings `@'...'@`**: They create actual newlines in XML instead of `\n` escape sequences

## Android String Resource Validation

The `strings.py` script performs comprehensive validation of all string content **before** writing to XML files. This catches errors that would break Android resource compilation.

### Validation Rules

The script validates **ALL** strings (with or without `--raw` flag):

#### Invalid Entity References
- ‚ùå `&pos;` - Common typo, breaks compilation ‚Üí Use `\'`
- ‚ùå `&apos;` - WRONG for Android XML, breaks compilation ‚Üí Use `\'`
- ‚ùå `&quot;` - Wrong for Android ‚Üí Use `\"`
- ‚úÖ `&amp;` `&lt;` `&gt;` - Valid XML entities
- ‚úÖ `&#123;` `&#x1F4A1;` - Numeric entities are valid

#### XML Structure
- ‚ùå Unquoted attributes: `id=value` ‚Üí Must be `id="value"`
- ‚ùå Unclosed tags: `<xliff:g>text` ‚Üí Must have `</xliff:g>`
- ‚ùå Mismatched tags: `<xliff:g></b>` ‚Üí Tags must match

#### Escape Requirements
- ‚úÖ Apostrophes: Use `\'` (backslash-escape)
- ‚úÖ Quotes: Use `\"` (backslash-escape)
- ‚ùå Do NOT use XML entities like `&apos;` or `&quot;`

### Example Validation Errors

```bash
# Invalid entity - will be rejected
python strings.py --set test el-rGR "Don&apos;t"
# ERROR: Entity '&apos;' detected! Use \' instead.

# Invalid typo - will be rejected
python strings.py --set test el-rGR "Test &pos; here"
# ERROR: Invalid entity '&pos;' detected! Use \' for apostrophes.

# Unquoted attribute - will be rejected
python strings.py --raw --set test el-rGR '<xliff:g id=bad>%s</xliff:g>'
# ERROR: Attribute value not quoted: id=bad
```

### What Gets Validated

- **Regular `--set`**: Validates THEN escapes automatically
- **With `--raw` flag**: Validates WITHOUT escaping (you provide pre-escaped content)

Both modes validate to prevent broken XML from reaching Android compilation.

### ‚ö†Ô∏è CRITICAL: PowerShell XML Quote Escaping

The strings.py script validates ALL XML content (with or without `--raw`) and will reject malformed XML before it breaks Android compilation.

**ALWAYS use single quotes in PowerShell to avoid accidental variable interpolation:**

‚úÖ **Single quotes (RECOMMENDED - works for everything):**
```powershell
# Simple strings
python strings.py --set string_id th-rTH '‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•'

# Strings with placeholders - $ is literal in single quotes
python strings.py --set string_id th-rTH '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î %1$s'

# Strings with double quotes inside - NO escaping needed!
python strings.py --set string_id th-rTH '‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà "%s"'

# Complex XML with double quotes - NO escaping needed!
python strings.py --raw --set message_ssl_error ro-rRO 'Text:\n<xliff:g id="domain_name" example="my.example.com"><b>%1$s</b></xliff:g>'

# Strings with apostrophes (single quotes) - double them up
python strings.py --set action_dont_allow th-rTH 'Don''t allow'
```

‚ùå **DO NOT use double quotes - risk of accidental variable interpolation:**
```powershell
# DANGEROUS - PowerShell may interpret $s as variable
python strings.py --set string_id th-rTH "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î %1$s"

# DANGEROUS - Need backtick escaping everywhere
python strings.py --raw --set test ro-rRO "Text:\n<xliff:g id=`"name`">%1`$s</xliff:g>"
```

‚ùå **WRONG - These break:**
```powershell
# Double quotes with backslash - PowerShell passes backslashes literally
python strings.py --raw --set test el-rGR "text <xliff:g id=\"x\">%s</xliff:g>"
# Result: <xliff:g id=\"x\"> (backslashes in XML = error)

# Here-strings create actual newlines instead of \n
$value = @'
Text:\n\nMore text
'@
python strings.py --raw --set test el-rGR $value
# Result: Actual line breaks in XML instead of \n escape sequences
```

**Why single quotes are best:**
- PowerShell treats everything literally - no variable expansion
- Dollar signs `$` in placeholders like `%1$s` work perfectly
- Double quotes in XML attributes need NO escaping
- Newlines `\n` stay as literal `\` and `n` characters (what we want)
- Only apostrophes need doubling: `''` ‚Üí becomes single `'`
- Safe from accidental PowerShell variable interpolation

**Common XML validation errors detected:**
- ‚ùå Backslashes in XML attributes (`id=\"value\"`) ‚Üí Use single quotes without escaping
- ‚ùå Missing quotes around attributes (`id=value`) ‚Üí Must use quotes (`id="value"`)
- ‚ùå Unclosed or mismatched XML tags
- ‚ùå Malformed XML structure
- ‚ùå Actual newlines in XML strings ‚Üí Use `\n` escape sequences instead

**Best practice:**
1. **Always use single quotes** `'...'` - Works for everything, no escaping needed
2. **Double apostrophes** `''` - Only when string contains single quotes
3. **DO NOT use double quotes** - Risk of variable interpolation
4. **DO NOT use here-strings** - They create actual newlines instead of `\n`

### ‚ö†Ô∏è CRITICAL: Apostrophe Escaping in Android XML

**Android XML string resources have specific escaping requirements that differ from standard XML:**

- ‚úÖ **CORRECT:** Use `\'` to escape apostrophes
  ```xml
  <string name="example">Don\'t use &apos; here</string>
  ```

- ‚ùå **WRONG:** Using `&apos;` will cause **build failures**
  ```xml
  <!-- This will FAIL to compile! -->
  <string name="example">Don&apos;t use this</string>
  ```

**The strings.py tool automatically detects and fixes `&apos;` issues:**
- When you use `--set` with a value containing `&apos;`, it will:
  1. Display a warning
  2. Automatically convert `&apos;` to `\'`
  3. Show you the before/after values

**Example:**
```bash
python strings.py --set do_not_track vi-rVN "Y√™u c·∫ßu &apos;Kh√¥ng theo d√µi&apos;"
```
Output:
```
[WARNING] Detected &apos; entity - this is INCORRECT for Android XML!
          Converting &apos; to \' (proper Android XML escape)
          Original value: Y√™u c·∫ßu &apos;Kh√¥ng theo d√µi&apos;
          Fixed value: Y√™u c·∫ßu 'Kh√¥ng theo d√µi'
[OK] Successfully updated do_not_track:vi-rVN
```

### ‚ö†Ô∏è CRITICAL: Placeholder and Format Specifier Requirements

**Format specifiers MUST match exactly between English and translations. This is enforced by the `--check` command.**

**Why this is critical:**
- **Missing placeholders** ‚Üí Text displays incorrectly (e.g., "Downloaded" instead of "Downloaded file.pdf")
- **Extra placeholders** ‚Üí App crashes at runtime with format exceptions
- **Wrong placeholder order** ‚Üí Wrong data in wrong position (e.g., "10 of 1" instead of "1 of 10")

**Common format specifiers:**
- `%s` - String placeholder
- `%d` - Integer placeholder
- `%1$s`, `%2$s` - Positional string placeholders
- `%1$d`, `%2$d` - Positional integer placeholders
- `<xliff:g id="name">%s</xliff:g>` - XML-tagged placeholders (must preserve entire tag)

**Examples of CORRECT translations:**

‚úÖ **Simple placeholder:**
```bash
# English: "Downloaded %s"
python strings.py --set string_id th-rTH '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î %s ‡πÅ‡∏•‡πâ‡∏ß'
# ‚úÖ Has exactly one %s
```

‚úÖ **Multiple positional placeholders:**
```bash
# English: "Match %1$d of %2$d"
python strings.py --set string_id th-rTH '‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô %1$d ‡∏à‡∏≤‡∏Å %2$d'
# ‚úÖ Has both %1$d and %2$d in any order
```

‚úÖ **XML-tagged placeholders:**
```bash
# English: 'Match <xliff:g id="current">%1$d</xliff:g> of <xliff:g id="total">%2$d</xliff:g>'
python strings.py --raw --set string_id th-rTH '‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô <xliff:g id=\"current\">%1$d</xliff:g> ‡∏à‡∏≤‡∏Å <xliff:g id=\"total\">%2$d</xliff:g>'
# ‚úÖ Both XML tags and placeholders preserved
```

**Examples of WRONG translations (will be flagged by --check):**

‚ùå **Missing placeholder:**
```bash
# English: "Downloaded %s" (1 placeholder)
python strings.py --set string_id th-rTH '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß'
# ‚ùå ERROR: Placeholder mismatch - missing %s
```

‚ùå **Extra placeholder:**
```bash
# English: "Downloaded" (0 placeholders)
python strings.py --set string_id th-rTH '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î %s ‡πÅ‡∏•‡πâ‡∏ß'
# ‚ùå ERROR: Placeholder mismatch - unexpected %s
```

‚ùå **Wrong placeholder type:**
```bash
# English: "Downloaded %d files" (%d = integer)
python strings.py --set string_id th-rTH '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î %s ‡πÑ‡∏ü‡∏•‡πå'
# ‚ùå ERROR: Placeholder mismatch - %s instead of %d
```

**The --check command will flag these as critical errors:**
```
th-rTH (1 issues):
  Placeholder mismatch: string_id
    English: ['%1$s', '%2$d']
    Translation: ['%1$s']
```

**Important rules:**
1. **Count must match** - Same number of placeholders in English and translation
2. **Types must match** - `%s` stays `%s`, `%d` stays `%d`, etc.
3. **IDs must match** - `%1$s` stays `%1$s` (can reorder, but IDs stay same)
4. **XML tags must be preserved** - Complete `<xliff:g>...</xliff:g>` structures
5. **Always run `--check`** before submitting translations to catch these errors


## Common Untranslated Strings

These strings are frequently untranslated across multiple languages:

### Format Placeholders
- `dialog_message_incoming_url` = `'%1$s\n\n%2$s'` - Intentionally left as-is

### User Agent Strings (Intentionally Untranslated)
- `agent_android_mobile` = `'Android (Mobile)'`
- `agent_ios_mobile` = `'iOS (Mobile)'`
- `agent_linux_desktop` = `'Linux (Desktop)'`
- `agent_macos_desktop` = `'macOS (Desktop)'`
- `agent_windows_desktop` = `'Windows (Desktop)'`

### Frequently Missing Translations
1. **Introduction/Settings:**
   - `pref_title_introduction` = `'Introduction'`
   - `pref_title_delete_configuration` = `'Delete configuration'`
   - `pref_title_add_configuration` = `'Add configuration'`

2. **Accent Colors:**
   - `accent_color`, `accent_amber`, `accent_blue`, `accent_cyan`, etc.

3. **Layer Types:**
   - `layer_type_none` = `'None'`
   - `layer_type_software` = `'Software - WebGL off'`
   - `layer_type_hardware` = `'Hardware - WebGL on'`

4. **SSL Information:**
   - `ssl_info_issued_by` = `'Issued by:'`
   - `ssl_info_issued_to` = `'Issued to:'`
   - `ssl_info_issued_on` = `'Issued on:'`
   - `ssl_info_expires_on` = `'Expires on:'`

5. **Session Management:**
   - `label_session` = `'Session'`
   - `session_recovery` = `'Recovery'`
   - `session_name_prompt` = `'Enter session name:'`

## Translation Quality Metrics

### Total Strings
- **Regular Strings:** 583
- **Plural Resources:** 2
  - `notification_incognito_running_title` (incognito tab count)
  - `pref_summary_cookies` (cookie count)

### Completion Criteria

A language is considered "complete" when:
1. All translatable strings are translated (excluding proper nouns)
2. All plural forms are properly handled
3. No placeholder mismatches exist
4. Near-match issues are resolved (punctuation, typos)

### Quality Checks Performed

1. **Untranslated Detection:** Exact match with English text
2. **Near-Match Detection:** 1-2 character differences (punctuation, typos)
3. **‚ö†Ô∏è Placeholder Consistency (CRITICAL):** Verify `%s`, `%1$s`, `%d`, `%1$d`, `<xliff:g>` tags match exactly
   - **Missing placeholders break the app** - text won't display correctly
   - **Extra placeholders crash the app** - causes runtime exceptions
   - All format specifiers must match between English and translation
   - This check is always performed and failures are flagged as critical errors
4. **Plural Completeness:** Check all required quantities are translated
5. **XML Validation:** Ensure proper XML structure and escaping

## Maintenance Tasks

### Adding New Strings

```bash
# Add a new string to English source file only
python strings.py --add new_feature_name "New Feature"
# Language files only contain translated strings to track progress accurately
```

### Removing Obsolete Strings

```bash
# Remove a string from all language files
python strings.py --remove obsolete_string_id
```

### Listing All Languages

```bash
python strings.py --list
```

## Best Practices

### For Translators

1. **Use Native Speakers:** Always prefer native speakers for translation quality
2. **Context Matters:** Understand the UI context where strings appear
3. **Consistency:** Use consistent terminology throughout translations
4. **Plural Forms:** Ensure proper plural forms for your language
5. **Format Preservation:** Maintain `%s`, `%1$d`, `<xliff:g>` placeholders exactly
6. **Cultural Appropriateness:** Adapt idioms and phrases culturally
7. **New Translations:** Use `--set` to add new translations - it will add the string to your language file if it exists in English but not yet translated

### For Developers

1. **Check Before Commit:** Run `python strings.py --check` before committing
2. **Update All Languages:** Use `--add` to add new strings to all languages
3. **Document Context:** Add comments in English strings.xml for context
4. **Test RTL Languages:** Test Arabic, Hebrew for right-to-left display
5. **Validate XML:** Ensure proper XML escaping for special characters

## Technical Details

### String Escaping Rules

**‚ö†Ô∏è Android XML Resources vs Standard XML:**

Android uses a **modified XML format** for string resources that has different escaping rules than standard XML:

**Regular Strings** (`--set`):
- Apostrophes (`'`) ‚Üí `\'` ‚úÖ **REQUIRED** (not `&apos;` ‚ùå)
- Quotes (`"`) ‚Üí `\"` ‚úÖ **REQUIRED** (not `&quot;` ‚ùå)
- Ampersands (`&`) ‚Üí `&amp;` (standard XML entity)
- Less than (`<`) ‚Üí `&lt;` (unless part of XML tag like `<xliff:g>`)
- Greater than (`>`) ‚Üí `&gt;` (unless part of XML tag)

**Why `&apos;` doesn't work:**
- Standard XML allows `&apos;` as a character entity
- Android's resource compiler does **NOT** accept `&apos;` in string values
- Using `&apos;` will cause: `Failed to compile values resource file` error
- Solution: Always use `\'` for apostrophes in Android string resources

**The strings.py tool protects you:**
- Automatically detects `&apos;` and `&quot;` in your input
- Displays warnings when these incorrect entities are found
- Converts them to the correct `\'` and `\"` escapes
- Prevents build failures before they happen

**Raw Strings** (`--raw` flag with `--set`):
- Use: `python strings.py --raw --set <lang> <id> <value>`
- No automatic escaping
- Used for complex XML with `<xliff:g>`, `<b>` tags
- Developer must handle escaping manually
- Still subject to Android's `\'` requirement (not `&apos;`)
- All content is still validated for XML correctness

### Plural Forms by Language

Different languages have different plural rules:

- **English, German, Dutch:** `one`, `other`
- **French, Portuguese:** `one`, `other`
- **Russian, Ukrainian:** `one`, `few`, `many`, `other`
- **Arabic:** `zero`, `one`, `two`, `few`, `many`, `other`
- **Korean, Japanese, Chinese:** `other` only (no plural distinction)
- **Polish:** `one`, `few`, `many`, `other`

## Known Issues

1. **Format Placeholder String:** `dialog_message_incoming_url` shows as "untranslated" in all languages - this is intentional as it's just `'%1$s\n\n%2$s'`

2. **Near-Match Default:** The tool defaults to `--near 1` to catch punctuation differences

3. **XML Encoding Issues:** Some language files may have encoding issues visible in logs (displayed as `ÔøΩÔøΩ` characters) but files are correctly UTF-8 encoded

## Future Improvements

1. **Crowdin Integration:** Document integration with Crowdin for community translations
2. **Translation Memory:** Build translation memory for consistency
3. **Automated Testing:** Add unit tests for translation completeness
4. **Context Screenshots:** Provide screenshots showing where strings appear in UI
5. **Glossary:** Create terminology glossary for consistent translations

## Support

For translation questions or issues:
1. Check this documentation first
2. Run `python strings.py --help` for command reference
3. Test translations with `python strings.py --check <lang>`
4. Open an issue on GitHub with the `l10n` label

---

## Regression Testing

### Overview

The `strings.py` script includes comprehensive Android string resource validation. These tests should be run after any changes to the script or to validate it's working correctly.

### Quick Validation Test Suite

Run these commands to verify all functionality:

```powershell
# 1. Test help displays correctly
python strings.py --help

# 2. Test language list
python strings.py --list

# 3. Test check command (should complete without errors)
python strings.py --check el-rGR

# 4. Test get command
python strings.py --get el-rGR show

# 5. Test get-plurals command
python strings.py --get-plurals el-rGR notification_incognito_running_title
```

### Validation Tests (Should Fail with Clear Errors)

These tests verify that validation is working correctly by testing invalid inputs:

```powershell
# Test 1: Invalid entity &pos; (should FAIL)
python strings.py --set show el-rGR "Test &pos; here"
# Expected: ERROR - Invalid entity '&pos;' detected!

# Test 2: Invalid entity &apos; (should FAIL)
python strings.py --raw --set show el-rGR "Don&apos;t use this"
# Expected: ERROR - Entity '&apos;' detected! Use \' instead.

# Test 3: Invalid entity &quot; (should FAIL)
python strings.py --raw --set show el-rGR 'Text &quot;quoted&quot;'
# Expected: ERROR - Entity '&quot;' detected! Use \" instead.

# Test 4: Unquoted XML attribute (should FAIL)
python strings.py --raw --set show el-rGR '<xliff:g id=bad>%s</xliff:g>'
# Expected: ERROR - Attribute value not quoted: id=bad

# Test 5: Mismatched XML tags (should FAIL)
python strings.py --raw --set show el-rGR '<xliff:g>text</b>'
# Expected: ERROR - Mismatched tags

# Test 7: Unclosed XML tag (should FAIL)
python strings.py --raw --set show el-rGR '<xliff:g id="test">text'
# Expected: ERROR - Unclosed tag(s)

# Test 8: Invalid custom entity (should FAIL)
python strings.py --raw --set show el-rGR 'Text &custom; entity'
# Expected: ERROR - Invalid entity reference(s): &custom;

# Test 9: Unterminated entity (should FAIL)
python strings.py --raw --set show el-rGR 'Text &amp more'
# Expected: ERROR - Unterminated entity reference: '&amp'
```

### Valid Input Tests (Should Succeed)

These tests verify that valid inputs are accepted:

```powershell
# Test 1: Simple text (should SUCCEED)
python strings.py --set show el-rGR "ŒïŒºœÜŒ¨ŒΩŒπœÉŒ∑"
# Expected: [OK] Successfully updated

# Test 2: Text with placeholder (should SUCCEED)
python strings.py --set dialog_title el-rGR '%1$s settings'
# Expected: [OK] Successfully updated

# Test 3: Valid XML with --raw and here-string (should SUCCEED)
$value = @'
Match <xliff:g id="current_match" example="1">%1$d</xliff:g> of <xliff:g id="match_count" example="10">%2$d</xliff:g>
'@
python strings.py --raw --set match_x_of_n el-rGR $value
# Expected: [OK] Successfully updated

# Test 4: Valid entities (should SUCCEED)
python strings.py --raw --set test el-rGR 'Text &amp; &lt; &gt; symbols'
# Expected: [OK] Successfully updated

# Test 5: Numeric entities (should SUCCEED)
python strings.py --raw --set test el-rGR 'Text &#169; &#x1F4A1; entities'
# Expected: [OK] Successfully updated

# Test 6: Batch update multiple languages (should SUCCEED)
python strings.py --set enable el-rGR 'ŒïŒΩŒµœÅŒ≥ŒøœÄŒøŒØŒ∑œÉŒ∑' fr-rFR 'Activer' de-rDE 'Aktivieren'
# Expected: [OK] for all three languages

# Test 7: Plural update (should SUCCEED)
python strings.py --set-plurals el-rGR notification_incognito_running_title other '%1$d tabs'
# Expected: [OK] Updated quantity 'other'
```

### XML Compilation Test

After any changes, verify that Android XML resources compile correctly:

```powershell
# Verify all translation files have valid XML structure (PowerShell multi-line)
python -c @"
import xml.etree.ElementTree as ET
import pathlib
res_dir = pathlib.Path('app/src/main/res')
files = list(res_dir.glob('values-*/strings.xml'))
print(f'Checking {len(files)} files...')
[ET.parse(f) for f in files]
print('All XML files valid!')
"@
```

### Automated Test Script

For convenience, create and use a test script:

```powershell
# Create test_l10n.ps1 to run all regression tests
# Then run it with:
.\test_l10n.ps1
```

### Test Coverage

The regression tests cover:

- ‚úÖ **Command Interface**: All commands execute without errors
- ‚úÖ **Validation Logic**: Invalid inputs are rejected with clear errors
- ‚úÖ **Valid Inputs**: Legitimate strings are accepted
- ‚úÖ **Android Entities**: `&apos;`, `&quot;`, `&pos;` detection
- ‚úÖ **XML Structure**: Tag matching, attribute quoting
- ‚úÖ **Entity References**: Valid vs invalid entities
- ‚úÖ **Batch Operations**: Multiple strings at once
- ‚úÖ **Plural Support**: Plural quantity handling
- ‚úÖ **XML Compilation**: Final XML is valid and parseable

### When to Run Tests

Run regression tests:

1. **After modifying `strings.py`** - Ensure changes didn't break existing functionality
2. **Before committing** - Verify all validation logic works
3. **When reporting issues** - Confirm the issue with test cases
4. **Periodically** - Ensure tool remains functional as project evolves

### Adding New Tests

When adding new validation rules to `strings.py`, add corresponding tests to this section showing:
1. What the rule validates
2. Example of invalid input that should be rejected
3. Example of valid input that should be accepted
4. Expected error message for failures

## Publishing to Google Play: `publish_google_play.py`

The `publish_google_play.py` script automates uploading translated metadata to Google Play Store.

### Prerequisites

1. **Python packages**:
   ```bash
   pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
   ```

2. **Google Play Service Account JSON key** - See project documentation for setup instructions.

### Usage

```bash
# Upload metadata (titles, descriptions)
python publish_google_play.py "path\to\service-account.json" com.example.app
```

**Parameters:**
- `service-account.json` - Path to Google Play API service account key
- `com.example.app` - Your Android app package name

### What It Does

1. **Authenticates** with Google Play API using service account
2. **Creates an edit session** for your app
3. **For each language** in `fastlane/metadata/android/`:
   - Reads `title.txt` (app name, max 30 chars)
   - Reads `short_description.txt` (tagline, max 80 chars)
   - Reads `full_description.txt` (feature list, max 4000 chars)
   - Uploads or updates the listing for that language
4. **Commits changes** to publish (or reports issues)

---

## Managing Changelogs: `changelogs.py`

The `fastlane/changelogs.py` script compiles changelogs from all languages into Google Play Console's bulk upload format.

### Location

```
fastlane/
‚îú‚îÄ‚îÄ publish_google_play.py  (upload metadata)
‚îî‚îÄ‚îÄ changelogs.py           (compile changelogs)
```

### Prerequisites

Changelog files must exist at: `fastlane/metadata/android/{language}/changelogs/{version}.txt`

**Important:**
- Changelog max length: 500 characters per language
- Changelogs are uploaded manually via Google Play Console bulk editor

### Usage

```bash
# Compile changelog template for version 239
python fastlane\changelogs.py 239
```

---

## Adding a New Language

### Overview

To add a new language to Fulguris, you need to:
1. Add Android string resource translations
2. Create Google Play metadata (title, descriptions)
3. Update the changelogs script
4. (Optional) Add to Google Play Console

### Step 1: Add Android String Translations

**Note:** The resource code uses Android's locale format (e.g., `en-rGB`), while Google Play uses its own format (e.g., `en-GB`).

```bash
# 1. Check if the language already has translations
python strings.py --check <resource-code>
# Example: python strings.py --check en-rGB

# 2. If missing, translate all strings (40 language batch recommended)
# Get list of string IDs to translate
python strings.py --get source <string_id>

# 3. Translate each string across languages
python strings.py --set <string_id> <resource-code> '<translation>'
# Example: python strings.py --set app_name en-rGB 'Fulguris'
```

### Step 2: Create Google Play Metadata

Create the following directory structure:

```
fastlane/metadata/android/<google-play-code>/
‚îú‚îÄ‚îÄ title.txt                 (30 chars max - app name)
‚îú‚îÄ‚îÄ short_description.txt     (80 chars max - tagline)
‚îú‚îÄ‚îÄ full_description.txt      (4000 chars max - description)
‚îî‚îÄ‚îÄ changelogs/
    ‚îú‚îÄ‚îÄ 251.txt
    ‚îú‚îÄ‚îÄ 252.txt
    ‚îî‚îÄ‚îÄ ...
```

**Example for English (UK):**

```bash
# Create directory
mkdir fastlane\metadata\android\en-GB

# Create title.txt (30 chars max)
echo "Fulguris" > fastlane\metadata\android\en-GB\title.txt

# Create short_description.txt (80 chars max)
echo "Fast, secure & open source web browser with ad blocker" > fastlane\metadata\android\en-GB\short_description.txt

# Create full_description.txt (4000 chars max)
# Copy from en-US and adapt for regional differences
copy fastlane\metadata\android\en-US\full_description.txt fastlane\metadata\android\en-GB\full_description.txt

# Create changelogs directory
mkdir fastlane\metadata\android\en-GB\changelogs
```

**File content guidelines:**
- **title.txt**: App name (usually same across languages)
- **short_description.txt**: One-line tagline highlighting key features
- **full_description.txt**: Full app description with features, privacy info, etc.
- Adapt American English spellings to British English (e.g., "color" ‚Üí "colour")

### Step 3: Update changelogs.py Script

Add the new language to the `languages` list in `fastlane/changelogs.py`:

```python
languages = [
    'en-US',  # English (US)
    'en-GB',  # English (UK) - ADD THIS
    'ar',     # Arabic
    # ... rest of languages
]
```

**Important:** Use Google Play language codes (e.g., `en-GB`), not Android resource codes (e.g., `en-rGB`).

### Step 4: Add to Google Play Console (Optional)

1. **Go to Google Play Console** ‚Üí Your App ‚Üí Store presence ‚Üí Main store listing
2. **Click "Add language"**
3. **Select the language** from the dropdown
4. **Copy metadata** from your local files:
   - Title from `title.txt`
   - Short description from `short_description.txt`
   - Full description from `full_description.txt`
5. **Save changes**

**Note:** Some languages may not be supported by Google Play Console (e.g., Bosnian, Santali).

### Step 5: Test and Verify

```bash
# 1. Check string translations are complete
python strings.py --check <resource-code>

# 2. Compile changelogs for a version
python fastlane\changelogs.py 252

# 3. Verify metadata files exist
dir fastlane\metadata\android\<google-play-code>

# 4. Sort strings to match source order
python strings.py --sort <resource-code>
```

### Language Code Reference

| Resource Code | Google Play Code | Language |
|---------------|------------------|----------|
| `en-rUS` | `en-US` | English (US) |
| `en-rGB` | `en-GB` | English (UK) |
| `ar-rSA` | `ar` | Arabic |
| `zh-rCN` | `zh-CN` | Chinese (Simplified) |
| `zh-rTW` | `zh-TW` | Chinese (Traditional) |
| `cs-rCZ` | `cs-CZ` | Czech |
| `da-rDK` | `da-DK` | Danish |
| `de-rDE` | `de-DE` | German |
| `fr-rFR` | `fr-FR` | French |
| `hi-rIN` | `hi-IN` | Hindi |
| `in-rID` | `id` | Indonesian |
| `ja-rJP` | `ja-JP` | Japanese |
| `ko-rKR` | `ko-KR` | Korean |

See [Google Play supported languages](https://support.google.com/googleplay/android-developer/table/4419860?hl=en) for complete list.

### Example: Adding English (UK)

```bash
# 1. String translations already exist in app/src/main/res/values-en-rGB/strings.xml
# (English UK is already translated)

# 2. Create metadata directory
mkdir fastlane\metadata\android\en-GB

# 3. Create metadata files
echo "Fulguris" > fastlane\metadata\android\en-GB\title.txt
echo "Fast, secure & open source web browser with ad blocker" > fastlane\metadata\android\en-GB\short_description.txt

# Copy and adapt full description
copy fastlane\metadata\android\en-US\full_description.txt fastlane\metadata\android\en-GB\full_description.txt
# Edit full_description.txt to use British English spellings

# 4. Create changelogs directory
mkdir fastlane\metadata\android\en-GB\changelogs

# 5. Copy existing changelogs (or translate from en-US)
copy fastlane\metadata\android\en-US\changelogs\*.txt fastlane\metadata\android\en-GB\changelogs\
# Edit changelogs to use British English spellings

# 6. Update changelogs.py to include 'en-GB'
# (see Step 3 above)

# 7. Test
python fastlane\changelogs.py 252
```

### What It Does

1. **Reads all changelog files** from `fastlane/metadata/android/{lang}/changelogs/239.txt`
2. **Compiles into Google Play format**:
   ```xml
   <en-US>
   üåç Now available in 25 languages!
   ...
   </en-US>

   <cs-CZ>
   üåç Nyn√≠ dostupn√© ve 25 jazyc√≠ch!
   ...
   </cs-CZ>
   ```
3. **Copies to clipboard** using PowerShell for proper UTF-8 encoding
4. **Shows statistics**: Found changelogs and any missing files

### Workflow

1. **Create changelog files** for each language in `fastlane/metadata/android/{lang}/changelogs/{version}.txt`
2. **Run changelogs.py**: `python fastlane\changelogs.py 239`
3. **Paste into Google Play Console**: Release management ‚Üí Edit release ‚Üí Release notes ‚Üí Use bulk editor
4. **Publish release**: Changelogs will be shown to users on update

### Configuration

Edit the script to change:
- **Package name**: `PACKAGE_NAME = 'net.slions.fulguris.full.playstore'`
- **Languages list**: Modify the `languages` array

### Notes

- Languages must be added in Play Console first (Store presence ‚Üí Main store listing)
- JSON key file must never be committed to Git (already excluded in `.gitignore`)
- Script validates string lengths and handles errors gracefully
